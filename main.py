import gradio as gr
import google.generativeai as genai
from pypdf import PdfReader
import os
import markdown
from xhtml2pdf import pisa
import requests

# --- CONFIGURATION ---
api_key = os.environ.get("GEMINI_API_KEY")
if not api_key:
    print("‚ö†Ô∏è Warning: GEMINI_API_KEY not found.")

genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.0-flash")

# --- GUMROAD AUTHENTICATION ENGINE ---
def verify_license(username, license_key):
    """
    Checks with Gumroad if the license key is valid.
    User enters:
    - Username: (Can be anything, or their email)
    - Password: The Gumroad License Key
    """
    # 1. Bypass for you (The Admin) - Optional
    if license_key == "admin_master_key_2026": 
        return True

    # 2. Check Gumroad API
    try:
        response = requests.post(
            "https://api.gumroad.com/v2/licenses/verify",
            data={
                "product_permalink": "YOUR_PRODUCT_PERMALINK_HERE", # <--- WE WILL FIX THIS IN STEP 3
                "license_key": license_key
            }
        )
        data = response.json()
        
        # 3. Validation Logic
        if data.get("success") == True:
            # Check if refunded or chargebacked
            if data["purchase"]["refunded"] or data["purchase"]["chargebacked"]:
                return False
            return True
        else:
            return False
            
    except Exception as e:
        print(f"Auth Error: {e}")
        return False

# --- PDF GENERATOR ---
def create_pdf(markdown_content):
    html_content = markdown.markdown(markdown_content)
    styled_html = f"""
    <html>
    <head>
        <style>
            @page {{ size: A4; margin: 2cm; }}
            body {{ font-family: Helvetica, sans-serif; font-size: 11pt; line-height: 1.5; color: #333; }}
            h1 {{ color: #2c3e50; border-bottom: 2px solid #2c3e50; }}
            h2 {{ color: #16a085; margin-top: 20px; }}
            .footer {{ position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 9pt; color: #7f8c8d; }}
        </style>
    </head>
    <body>
        {html_content}
        <div class='footer'>Generated by AI Executive Career Architect</div>
    </body>
    </html>
    """
    output_filename = "Executive_Strategy_Report.pdf"
    with open(output_filename, "wb") as f:
        pisa.CreatePDF(styled_html, dest=f)
    return output_filename

# --- CORE LOGIC ---
def extract_pdf_text(filepath):
    if not filepath: return ""
    try:
        reader = PdfReader(filepath)
        text = ""
        for page in reader.pages: text += page.extract_text() + "\n"
        return text
    except Exception as e: return str(e)

def career_coach_logic(resume_file, jd_file):
    if not resume_file or not jd_file:
        return "‚ö†Ô∏è Please upload BOTH files.", None

    res_text = extract_pdf_text(resume_file)
    jd_text = extract_pdf_text(jd_file)

    prompt = f"""
    ROLE: Executive Career Strategist.
    INPUTS: RESUME: {res_text} | JD: {jd_text}
    
    OUTPUT FORMAT (Markdown):
    # üèÅ STRATEGIC ANALYSIS
    * **Status:** [MATCH SCORE]
    * **Verdict:** (Summary)
    
    # üö© GAPS
    * (List gaps)
    
    # ‚úçÔ∏è REWRITE (Professional Summary & Experience)
    (Rewrite top 2 roles using CAR format)
    
    # ‚úâÔ∏è OUTREACH
    (Email hook)
    """
    
    try:
        response = model.generate_content(prompt)
        ai_text = response.text
        pdf_path = create_pdf(ai_text)
        return ai_text, pdf_path
    except Exception as e:
        return f"Error: {e}", None

# --- UI SETUP ---
with gr.Blocks(theme=gr.themes.Soft(primary_hue="slate")) as app:
    gr.Markdown("# üèõÔ∏è Executive Career Architect")
    
    with gr.Row():
        res_upload = gr.File(label="Resume (PDF)", file_types=[".pdf"])
        jd_upload = gr.File(label="Target JD (PDF)", file_types=[".pdf"])
    
    btn = gr.Button("Generate Strategy", variant="primary")
    
    with gr.Row():
        output_box = gr.Markdown()
        pdf_download = gr.File(label="Download Report")
    
    btn.click(fn=career_coach_logic, inputs=[res_upload, jd_upload], outputs=[output_box, pdf_download])

# --- LAUNCH WITH DYNAMIC AUTH ---
PORT = int(os.environ.get("PORT", 7860))
app.launch(
    server_name="0.0.0.0", 
    server_port=PORT, 
    auth=verify_license, 
    auth_message="Enter 'vip' as username, and your GUMROAD LICENSE KEY as the password."
)
