import gradio as gr
import google.generativeai as genai
from pypdf import PdfReader
import os
import markdown
from xhtml2pdf import pisa
import requests

# --- 1. CONFIGURATION ---
# The Brain
api_key = os.environ.get("GEMINI_API_KEY")
if not api_key:
    print("‚ö†Ô∏è Warning: GEMINI_API_KEY not found. App may crash.")

genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.0-flash")

# The Gatekeeper (Your Gumroad ID)
GUMROAD_PRODUCT_ID = "A70XLqybP3M3f6C-euPZzg=="

# --- 2. GUMROAD AUTHENTICATION ENGINE ---
def verify_license(username, license_key):
    """
    Verifies the license key against your specific Gumroad product.
    """
    # Master Key for you (The Admin) to bypass checks
    if license_key == "admin_master_2026": 
        return True

    try:
        # We assume the user enters their License Key as the "Password"
        # The 'username' field is ignored by Gumroad, but required by Gradio's UI.
        
        response = requests.post(
            "https://api.gumroad.com/v2/licenses/verify",
            data={
                "product_permalink": GUMROAD_PRODUCT_ID, 
                "license_key": license_key
            }
        )
        
        data = response.json()
        
        # Validation Logic
        if data.get("success") == True:
            # Check if refunded or chargebacked
            if data["purchase"]["refunded"] or data["purchase"]["chargebacked"]:
                print(f"‚ùå License {license_key} was refunded.")
                return False
            # If active and not refunded, let them in!
            return True
        else:
            print(f"‚ùå Verification failed for key: {license_key}")
            return False
            
    except Exception as e:
        print(f"‚ö†Ô∏è Auth Error: {e}")
        # Fail safe: If Gumroad is down, don't let people in for free.
        return False

# --- 3. PDF GENERATOR ---
def create_pdf(markdown_content):
    html_content = markdown.markdown(markdown_content)
    styled_html = f"""
    <html>
    <head>
        <style>
            @page {{ size: A4; margin: 2cm; }}
            body {{ font-family: Helvetica, sans-serif; font-size: 11pt; line-height: 1.5; color: #333; }}
            h1 {{ color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 8px; }}
            h2 {{ color: #16a085; margin-top: 20px; font-weight: bold; }}
            strong {{ color: #000; }}
            .footer {{ position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 9pt; color: #7f8c8d; border-top: 1px solid #ddd; padding-top: 10px; }}
        </style>
    </head>
    <body>
        <h1>Executive Strategy Report</h1>
        {html_content}
        <div class='footer'>Generated by AI Executive Career Architect ‚Ä¢ Confidential</div>
    </body>
    </html>
    """
    output_filename = "Executive_Strategy_Report.pdf"
    with open(output_filename, "wb") as f:
        pisa.CreatePDF(styled_html, dest=f)
    return output_filename

# --- 4. CORE LOGIC ---
def extract_pdf_text(filepath):
    if not filepath: return ""
    try:
        reader = PdfReader(filepath)
        text = ""
        for page in reader.pages: text += page.extract_text() + "\n"
        return text
    except Exception as e: return str(e)

def career_coach_logic(resume_file, jd_file):
    if not resume_file or not jd_file:
        return "‚ö†Ô∏è Please upload BOTH files.", None

    res_text = extract_pdf_text(resume_file)
    jd_text = extract_pdf_text(jd_file)

    # The Prompt (Your IP)
    prompt = f"""
    # SYSTEM INSTRUCTIONS: Executive Resume Rewriter
    
    ROLE: Executive Career Strategist (Director/VP level).
    INPUTS: 1) RESUME: {res_text} | 2) JD: {jd_text}
    
    OUTPUT FORMAT (Strict Markdown):

    # üèÅ PART 1: STRATEGIC ANALYSIS
    ## üö¶ The Verdict
    * **Status:** [STRONG MATCH / POSSIBLE / WEAK]
    * **Score:** [0-100]
    * **Summary:** (2 sentences)

    ## üö© Critical Gaps
    * **Gap 1:** ...
    * **Gap 2:** ...

    ---
    # ‚úçÔ∏è PART 2: THE REWRITE
    ## üíé Professional Summary
    (Rewrite bio highlighting UVP)

    ## üõ†Ô∏è Core Competencies (ATS Grid)
    (3x3 Grid of Hard Skills found in JD)

    ## üöÄ Experience (Top 2 Roles)
    (Rewrite using CAR Framework: Context, Action, Result)

    ---
    # ‚úâÔ∏è PART 3: OUTREACH
    ## üéØ Email Hook
    (3-sentence cold email opener)
    """
    
    try:
        response = model.generate_content(prompt)
        ai_text = response.text
        pdf_path = create_pdf(ai_text)
        return ai_text, pdf_path
    except Exception as e:
        return f"Error: {e}", None

# --- 5. THE UI ---
with gr.Blocks(theme=gr.themes.Soft(primary_hue="slate")) as app:
    gr.Markdown("# üèõÔ∏è Executive Career Architect")
    gr.Markdown("üîí **Secure Login Required.** Please enter your Gumroad License Key.")
    
    with gr.Row():
        res_upload = gr.File(label="1. Executive Resume (PDF)", file_types=[".pdf"])
        jd_upload = gr.File(label="2. Target Job Description (PDF)", file_types=[".pdf"])
    
    btn = gr.Button("Generate Strategy & Report", variant="primary", size="lg")
    
    with gr.Row():
        output_box = gr.Markdown(label="Strategic Analysis")
        pdf_download = gr.File(label="Download Official Report (PDF)")
    
    btn.click(fn=career_coach_logic, inputs=[res_upload, jd_upload], outputs=[output_box, pdf_download])

# --- 6. LAUNCH ---
PORT = int(os.environ.get("PORT", 7860))

app.launch(
    server_name="0.0.0.0", 
    server_port=PORT, 
    auth=verify_license, 
    auth_message="1. Username: vip\n2. Password: Your Gumroad License Key"
)
