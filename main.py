import gradio as gr
import google.generativeai as genai
from pypdf import PdfReader
import os
import markdown
from xhtml2pdf import pisa
import requests

# --- 1. CONFIGURATION ---
api_key = os.environ.get("GEMINI_API_KEY")
if not api_key:
    print("‚ö†Ô∏è SYSTEM ALERT: GEMINI_API_KEY is missing.")

genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.0-flash")

GUMROAD_PRODUCT_ID = "A70XLqybP3M3f6C-euPZzg=="

# --- 2. AUTHENTICATION LOGIC ---
def verify_gumroad_key(license_key):
    license_key = str(license_key).strip()
    
    # Backdoor for you (optional)
    if license_key == "admin_2026": 
        return True, "Welcome Admin."

    if not license_key:
        return False, "‚ö†Ô∏è Please enter a license key."

    try:
        response = requests.post(
            "https://api.gumroad.com/v2/licenses/verify",
            data={
                "product_permalink": GUMROAD_PRODUCT_ID,
                "license_key": license_key
            },
            timeout=5
        )
        data = response.json()
        
        if data.get("success") == True:
            if data["purchase"].get("refunded", False):
                return False, "‚ùå Access Denied: This purchase was refunded."
            if data["purchase"].get("chargebacked", False):
                return False, "‚ùå Access Denied: Payment dispute detected."
            return True, "‚úÖ Success! Loading AI..."
        else:
            return False, "‚ùå Invalid License Key. Please check your email."
            
    except Exception as e:
        return False, f"‚ö†Ô∏è Connection Error: {e}"

# --- 3. PDF GENERATOR ---
def create_pdf(markdown_content):
    html_content = markdown.markdown(markdown_content)
    styled_html = f"""
    <html>
    <head>
        <style>
            @page {{ size: A4; margin: 2.5cm; }}
            body {{ font-family: Helvetica, sans-serif; font-size: 11pt; line-height: 1.6; color: #333; }}
            h1 {{ color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; font-size: 18pt; }}
            h2 {{ color: #2980b9; margin-top: 25px; font-size: 14pt; font-weight: bold; }}
            h3 {{ color: #7f8c8d; font-size: 12pt; text-transform: uppercase; margin-top: 20px; }}
            strong {{ color: #000; }}
            .footer {{ position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 9pt; color: #95a5a6; border-top: 1px solid #bdc3c7; padding-top: 10px; }}
        </style>
    </head>
    <body>
        <h1>Executive Career Strategy</h1>
        {html_content}
        <div class='footer'>Confidential ‚Ä¢ Generated by AI Career Architect</div>
    </body>
    </html>
    """
    output_filename = "Executive_Strategy_Report.pdf"
    with open(output_filename, "wb") as f:
        pisa.CreatePDF(styled_html, dest=f)
    return output_filename

# --- 4. CORE AI LOGIC ---
def extract_pdf_text(filepath):
    if not filepath: return ""
    try:
        reader = PdfReader(filepath)
        text = ""
        for page in reader.pages: text += page.extract_text() + "\n"
        return text
    except Exception as e: return str(e)

def career_coach_logic(license_key, resume_file, jd_file):
    is_valid, msg = verify_gumroad_key(license_key)
    if not is_valid:
        return f"üîí SECURITY ALERT: {msg}", None

    if not resume_file or not jd_file:
        return "‚ö†Ô∏è Please upload BOTH files to begin.", None

    res_text = extract_pdf_text(resume_file)
    jd_text = extract_pdf_text(jd_file)

    prompt = f"""
    ROLE: Executive Career Strategist.
    INPUTS: RESUME: {res_text} | JD: {jd_text}
    OBJECTIVE: Ruthless executive gap analysis and rewrite.
    OUTPUT: Strict Markdown.
    
    # üèÅ PART 1: STRATEGIC FIT
    ## üö¶ The Verdict
    * **Status:** [STRONG/POSSIBLE/WEAK]
    * **Score:** [0-100]
    * **Executive Summary:** (2 sentences)
    ## üö© Critical Gaps
    * Gap 1...
    * Gap 2...
    ---
    # ‚úçÔ∏è PART 2: THE REWRITE
    ## üíé Professional Summary
    (Rewrite bio)
    ## üõ†Ô∏è Core Competencies (ATS Grid)
    (3x4 Grid)
    ## üöÄ Experience (Top 2 Roles)
    (CAR Framework)
    ---
    # ‚úâÔ∏è PART 3: OUTREACH
    ## üéØ Email Hook
    """
    
    try:
        response = model.generate_content(prompt)
        ai_text = response.text
        pdf_path = create_pdf(ai_text)
        return ai_text, pdf_path
    except Exception as e:
        return f"System Error: {e}", None

# --- 5. THE UI (CUSTOM LOGIN FLOW) ---
# We use the local file. Make sure you upload 'logo.jpg' to GitHub!
LOGO_PATH = "logo.jpg" 

with gr.Blocks(theme=gr.themes.Soft(primary_hue="slate", radius_size="none")) as app:
    
    # State
    user_key_state = gr.State("")

    # --- VIEW 1: LOGIN ---
    with gr.Column(visible=True) as login_view:
        gr.Markdown("## ")
        with gr.Row():
            with gr.Column(scale=1): pass
            with gr.Column(scale=2):
                # CLEANED: Removed 'show_download_button' etc.
                # If logo.jpg is missing, this box will just be empty (won't crash)
                if os.path.exists(LOGO_PATH):
                    gr.Image(value=LOGO_PATH, show_label=False, height=200)
                else:
                    gr.Markdown("*(Logo not found: Please upload logo.jpg to GitHub)*")

                gr.Markdown("# üîí Client Portal Access")
                gr.Markdown("Please enter your **Gumroad License Key** to proceed.")
                
                # CLEANED: Removed 'show_copy_button'
                key_input = gr.Textbox(
                    label="License Key", 
                    placeholder="e.g. 1234-5678-ABCD-EFGH", 
                    type="password"
                )
                login_btn = gr.Button("Unlock Access", variant="primary")
                login_msg = gr.Markdown("")
            with gr.Column(scale=1): pass

    # --- VIEW 2: MAIN APP ---
    with gr.Column(visible=False) as main_view:
        with gr.Row():
            if os.path.exists(LOGO_PATH):
                gr.Image(value=LOGO_PATH, show_label=False, height=50, scale=0)
            gr.Markdown("# üèõÔ∏è AI Career Architect")
        
        gr.Markdown("---")
        
        with gr.Row():
            res_upload = gr.File(label="üìÇ 1. Upload Executive Resume (PDF)", file_types=[".pdf"])
            jd_upload = gr.File(label="üéØ 2. Upload Target JD (PDF)", file_types=[".pdf"])
        
        generate_btn = gr.Button("‚ú® Generate Strategy & Rewrite", variant="primary", size="lg")
        
        with gr.Row():
            output_box = gr.Markdown(label="Strategic Analysis")
            pdf_download = gr.File(label="üìÑ Download Report")

    # --- 6. EVENT WIRING ---
    def attempt_login(key):
        is_valid, msg = verify_gumroad_key(key)
        if is_valid:
            return {
                login_view: gr.update(visible=False),
                main_view: gr.update(visible=True),
                user_key_state: key,
                login_msg: ""
            }
        else:
            return {
                login_view: gr.update(visible=True),
                main_view: gr.update(visible=False),
                user_key_state: "",
                login_msg: f"‚ö†Ô∏è {msg}"
            }

    login_btn.click(
        fn=attempt_login,
        inputs=[key_input],
        outputs=[login_view, main_view, user_key_state, login_msg]
    )

    generate_btn.click(
        fn=career_coach_logic,
        inputs=[user_key_state, res_upload, jd_upload],
        outputs=[output_box, pdf_download]
    )

# --- 7. LAUNCH ---
PORT = int(os.environ.get("PORT", 7860))
app.launch(server_name="0.0.0.0", server_port=PORT)
