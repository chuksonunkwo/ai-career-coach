import gradio as gr
import google.generativeai as genai
from pypdf import PdfReader
import os
import markdown
from xhtml2pdf import pisa

# --- CONFIGURATION ---
api_key = os.environ.get("GEMINI_API_KEY")
if not api_key:
    print("‚ö†Ô∏è Warning: GEMINI_API_KEY not found. App may crash.")

genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.0-flash")

# --- PDF GENERATOR ENGINE (Styling) ---
def create_pdf(markdown_content):
    """Converts Markdown to a Professional PDF"""
    
    html_content = markdown.markdown(markdown_content)
    
    # Corporate Styling with clean fonts and colors
    styled_html = f"""
    <html>
    <head>
        <style>
            @page {{
                size: A4;
                margin: 2cm;
            }}
            body {{
                font-family: Helvetica, Arial, sans-serif;
                font-size: 11pt;
                line-height: 1.5;
                color: #333333;
            }}
            h1 {{
                color: #2c3e50;
                font-size: 18pt;
                border-bottom: 2px solid #2c3e50;
                padding-bottom: 8px;
                margin-top: 0px;
            }}
            h2 {{
                color: #16a085;
                font-size: 14pt;
                margin-top: 20px;
                margin-bottom: 8px;
                font-weight: bold;
            }}
            strong {{
                color: #000000;
            }}
            ul {{
                margin-bottom: 10px;
            }}
            li {{
                margin-bottom: 4px;
            }}
            .footer {{
                position: fixed;
                bottom: 0;
                width: 100%;
                text-align: center;
                font-size: 9pt;
                color: #95a5a6;
                border-top: 1px solid #bdc3c7;
                padding-top: 10px;
            }}
        </style>
    </head>
    <body>
        {html_content}
        <div class='footer'>
            Generated by AI Executive Career Architect ‚Ä¢ Strategy Report
        </div>
    </body>
    </html>
    """
    
    output_filename = "Executive_Strategy_Report.pdf"
    with open(output_filename, "wb") as f:
        pisa.CreatePDF(styled_html, dest=f)
    
    return output_filename

# --- CORE LOGIC ---
def extract_pdf_text(filepath):
    if not filepath: return ""
    try:
        reader = PdfReader(filepath)
        text = ""
        for page in reader.pages:
            text += page.extract_text() + "\n"
        return text
    except Exception as e:
        return f"Error reading file: {e}"

def career_coach_logic(resume_file, jd_file):
    if not resume_file or not jd_file:
        return "‚ö†Ô∏è Please upload BOTH files to start.", None

    res_text = extract_pdf_text(resume_file)
    jd_text = extract_pdf_text(jd_file)

    # --- THE UPDATED EXECUTIVE PROMPT ---
    prompt = f"""
    # SYSTEM INSTRUCTIONS: Executive Resume Rewriter

    **ROLE:** You are a elite Executive Resume Writer and Strategist (Director/VP level).
    **GOAL:** Analyze the candidate's fit, then REWRITE key sections of their CV to perfectly align with the target role.

    **INPUTS:**
    1) RESUME: {res_text}
    2) JOB DESCRIPTION: {jd_text}

    **CORE RULES (INTEGRITY):**
    1. **No Fabrication:** Do not invent jobs, degrees, or numbers. If a metric is missing, use `[MEASURABLE IMPACT]` as a placeholder.
    2. **Executive Tone:** Remove passive voice ("Responsible for..."). Use active, powerful verbs ("Orchestrated," "Turned around," "Scaled").
    3. **The "So What?" Test:** Every bullet point must answer "So what?" by showing a result, not just a task.

    ---
    **OUTPUT FORMAT (Strict Markdown):**

    # üèÅ PART 1: STRATEGIC ANALYSIS
    ## üö¶ The Verdict
    * **Status:** [STRONG MATCH / POSSIBLE / WEAK]
    * **Score:** [0-100]
    * **Executive Summary:** (2 sentences on why they fit or don't fit.)

    ## üö© Critical Gaps
    * **Gap 1:** (Skill/Experience missing)
    * **Gap 2:** (Skill/Experience missing)

    ---
    # ‚úçÔ∏è PART 2: THE REWRITE (Copy/Paste Ready)

    ## üíé Professional Summary (Rewritten)
    *(Write a compelling 3-4 line bio. Position them as the specific title in the JD. Highlight their "Unique Value Proposition" based on the match between their history and the JD's pain points.)*

    ## üõ†Ô∏è Core Competencies (The "ATS" Section)
    *(List 9-12 hard skills/keywords found in the JD that the candidate actually possesses. Format as a 3x3 or 4x3 grid using " | " separators.)*

    ## üöÄ Experience Section (Top 2 Roles Rewritten)
    *(Rewrite the most recent 2 roles. For each role, provide:*
    * *A 1-sentence "Role Scope" (Budget, Team Size, Mandate).*
    * *3-4 High-Impact Bullets using the **CAR** framework (Context -> Action -> Result).*
    * *Ensure JD keywords are naturally integrated.)*

    **[Role 1 Title]** | **[Company]** | *[Dates]*
    * **Scope:** ...
    * (Bullet 1)
    * (Bullet 2)
    * (Bullet 3)

    **[Role 2 Title]** | **[Company]** | *[Dates]*
    * **Scope:** ...
    * (Bullet 1)
    * (Bullet 2)
    * (Bullet 3)

    ---
    # ‚úâÔ∏è PART 3: THE OUTREACH
    ## üéØ Hiring Manager Email Hook
    *(A 3-sentence "cold email" opener connecting their biggest relevant win to the company's current goals.)*
    """
    
    try:
        # 1. Generate Text
        response = model.generate_content(prompt)
        ai_text = response.text
        
        # 2. Generate PDF
        pdf_path = create_pdf(ai_text)
        
        return ai_text, pdf_path
        
    except Exception as e:
        return f"AI Error: {e}", None

# --- THE UI ---
with gr.Blocks(theme=gr.themes.Soft(primary_hue="slate")) as app:
    gr.Markdown("# üèõÔ∏è Executive Career Architect")
    gr.Markdown("Exclusive Access. Upload your Resume + Target JD to generate a Boardroom-Ready Strategy & Rewrite.")
    
    with gr.Row():
        res_upload = gr.File(label="1. Executive Resume (PDF)", file_types=[".pdf"])
        jd_upload = gr.File(label="2. Target Job Description (PDF)", file_types=[".pdf"])
    
    btn = gr.Button("Generate Strategy & Report", variant="primary", size="lg")
    
    with gr.Row():
        output_box = gr.Markdown(label="Strategic Analysis")
        pdf_download = gr.File(label="Download Official Report (PDF)")
    
    btn.click(fn=career_coach_logic, inputs=[res_upload, jd_upload], outputs=[output_box, pdf_download])

# Launch
PORT = int(os.environ.get("PORT", 7860))
app.launch(server_name="0.0.0.0", server_port=PORT, auth=("vip_user", "career2026"))
